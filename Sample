# === One-shot copy logs from scheduler -> web (PowerShell) ===
# Adjust local temp path if needed
$localTar = "C:\Windows\Temp\airflow-logs.tgz"

# find pod names (first web and first scheduler)
$web   = (kubectl get pods -n airflow --no-headers | Select-String "web"       | ForEach-Object { ($_ -split '\s+')[0] } | Select-Object -First 1)
$sched = (kubectl get pods -n airflow --no-headers | Select-String "scheduler" | ForEach-Object { ($_ -split '\s+')[0] } | Select-Object -First 1)

if (-not $web -or -not $sched) {
  Write-Error "Could not find web or scheduler pods in namespace 'airflow'. Run 'kubectl get pods -n airflow' and re-run."
  return
}

Write-Host "Scheduler pod: $sched"
Write-Host "Web pod:       $web"
Write-Host "Creating tar of /opt/airflow/logs from scheduler pod..."

# 1) Create tar on local machine by streaming from scheduler (safe)
kubectl exec -n airflow $sched -- bash -c "cd /opt/airflow && tar czf - logs" > $localTar

if (-not (Test-Path $localTar)) {
  Write-Error "Failed to create local tar file $localTar"
  return
}

Write-Host "Tar created locally at $localTar. Streaming into web pod..."

# 2) Stream the tar into the web pod (no kubectl cp)
#    Use Get-Content -Encoding Byte to stream raw bytes into kubectl exec -i.
Get-Content -Encoding Byte $localTar -ReadCount 0 | kubectl exec -i -n airflow $web -- bash -c "cat > /tmp/airflow-logs.tgz"

# 3) Extract inside web pod to /opt/airflow (create dir if missing) and cleanup
kubectl exec -n airflow $web -- bash -c "mkdir -p /opt/airflow && tar xzf /tmp/airflow-logs.tgz -C /opt/airflow && rm -f /tmp/airflow-logs.tgz"

Write-Host "Done. Logs copied to /opt/airflow/logs on web pod $web"

# Optional: remove local tar
Remove-Item $localTar -ErrorAction SilentlyContinue
